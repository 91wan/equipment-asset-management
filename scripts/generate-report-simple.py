#!/usr/bin/env python3
"""
Equipment Asset Management - Simple Report Generator
ç”Ÿæˆç®€åŒ–ç‰ˆ Markdown æŠ¥å‘Š
"""

import json
import argparse
from pathlib import Path
from datetime import datetime
from calculate_cost import calculate


def generate_markdown_report(data: dict) -> str:
    """ç”Ÿæˆ Markdown æŠ¥è¡¨"""
    
    meta = data.get("meta", {})
    equipment_list = data.get("equipment", [])
    
    lines = [
        "# ğŸ“± Equipment Asset Report",
        "",
        f"> Generated: {meta.get('calculated_at', datetime.now().strftime('%Y-%m-%d %H:%M'))}",
        f"> Base Currency: {meta.get('base_currency', 'CNY')}",
        "",
        "---",
        "",
        "## ğŸ“Š Summary",
        "",
    ]
    
    # ç»Ÿè®¡æ•°æ®
    total_price = sum(item.get("price", 0) for item in equipment_list)
    total_residual = sum(item.get("residual_value", 0) for item in equipment_list)
    
    lines.extend([
        f"- **Total Equipment**: {len(equipment_list)} items",
        f"- **Total Investment**: Â¥{total_price:,.2f}",
        f"- **Residual Value**: Â¥{total_residual:,.2f}",
        f"- **Depreciation**: Â¥{total_price - total_residual:,.2f} ({((total_price - total_residual)/total_price*100):.1f}%)",
        "",
        "---",
        "",
        "## ğŸ“‹ Equipment List",
        "",
    ])
    
    # åˆ†ç±»
    categories = {}
    for item in equipment_list:
        cat = item.get("category", "other")
        if cat not in categories:
            categories[cat] = []
        categories[cat].append(item)
    
    cat_names = {
        "computer": "ğŸ’» Computer",
        "phone": "ğŸ“± Phone",
        "tablet": "ğŸ“± Tablet",
        "wearable": "âŒš Wearable",
        "smart-home": "ğŸ  Smart Home",
        "other": "ğŸ“¦ Other"
    }
    
    for cat, items in sorted(categories.items()):
        lines.extend([
            f"### {cat_names.get(cat, cat)} ({len(items)} items)",
            "",
            "| Name | Purchase | Price | Days | Daily Cost | Status | Residual |",
            "|:---|:---|---:|---:|---:|:---|---:|",
        ])
        
        for item in items:
            lines.append(
                f"| {item.get('name', 'N/A')[:20]} | "
                f"{item.get('purchase_date', '-')} | "
                f"Â¥{item.get('price', 0):,.0f} | "
                f"{item.get('days_used', 0)} | "
                f"Â¥{item.get('daily_cost', 0):.1f} | "
                f"{item.get('status_emoji', 'âšª')} {item.get('status', '')} | "
                f"Â¥{item.get('residual_value', 0):,.0f} |"
            )
        
        cat_price = sum(i.get("price", 0) for i in items)
        cat_residual = sum(i.get("residual_value", 0) for i in items)
        lines.extend([
            "",
            f"**Subtotal**: Â¥{cat_price:,.0f} â†’ Â¥{cat_residual:,.0f}",
            "",
        ])
    
    lines.extend([
        "---",
        "",
        "## ğŸ’¡ Recommendations",
        "",
        "### ğŸŸ¢ Keep Using",
        "",
    ])
    
    for item in equipment_list:
        if item.get("daily_cost", 0) < 10:
            lines.append(f"- **{item.get('name')}**: Daily cost Â¥{item.get('daily_cost', 0):.1f} - very cost-effective")
    
    lines.extend([
        "",
        "### ğŸ”´ Consider Replacement",
        "",
    ])
    
    for item in equipment_list:
        if item.get("years_used", 0) > 4:
            lines.append(f"- **{item.get('name')}**: Used {item.get('years_used', 0):.1f} years - consider upgrading")
    
    lines.extend([
        "",
        "---",
        "",
        "_Generated by Equipment Asset Management_",
        "",
    ])
    
    return "\n".join(lines)


def main():
    parser = argparse.ArgumentParser(description="ç”Ÿæˆè®¾å¤‡æŠ¥è¡¨")
    parser.add_argument("--input", "-i", required=True, help="è¾“å…¥ JSON æ–‡ä»¶")
    parser.add_argument("--output", "-o", help="è¾“å‡ºæ–‡ä»¶è·¯å¾„")
    args = parser.parse_args()
    
    input_path = Path(args.input)
    if not input_path.exists():
        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {input_path}")
        return 1
    
    with open(input_path, "r", encoding="utf-8") as f:
        data = json.load(f)
    
    report = generate_markdown_report(data)
    
    if args.output:
        output_path = Path(args.output)
        output_path.write_text(report, encoding="utf-8")
        print(f"âœ… æŠ¥è¡¨å·²ä¿å­˜: {output_path}")
    else:
        print(report)
    
    return 0


if __name__ == "__main__":
    exit(main())
